/*!
 * etag
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */

'use strict'

/**
 * Module exports.
 * @public
 */

module.exports = etag

/**
 * Module dependencies.
 * @private
 */

var crypto = require('crypto')
var Stats = require('fs').Stats

/**
 * Module variables.
 * @private
 */

var base64PadCharRegExp = /=+$/
var toString = Object.prototype.toString

/**
 * Generate an entity tag.
 *
 * @param ***REMOVED***Buffer|string***REMOVED*** entity
 * @return ***REMOVED***string***REMOVED***
 * @private
 */

function entitytag(entity) ***REMOVED***
  if (entity.length === 0) ***REMOVED***
    // fast-path empty
    return '"0-1B2M2Y8AsgTpgAmY7PhCfg"'
  ***REMOVED***

  // compute hash of entity
  var hash = crypto
    .createHash('md5')
    .update(entity, 'utf8')
    .digest('base64')
    .replace(base64PadCharRegExp, '')

  // compute length of entity
  var len = typeof entity === 'string'
    ? Buffer.byteLength(entity, 'utf8')
    : entity.length

  return '"' + len.toString(16) + '-' + hash + '"'
***REMOVED***

/**
 * Create a simple ETag.
 *
 * @param ***REMOVED***string|Buffer|Stats***REMOVED*** entity
 * @param ***REMOVED***object***REMOVED*** [options]
 * @param ***REMOVED***boolean***REMOVED*** [options.weak]
 * @return ***REMOVED***String***REMOVED***
 * @public
 */

function etag(entity, options) ***REMOVED***
  if (entity == null) ***REMOVED***
    throw new TypeError('argument entity is required')
  ***REMOVED***

  // support fs.Stats object
  var isStats = isstats(entity)
  var weak = options && typeof options.weak === 'boolean'
    ? options.weak
    : isStats

  // validate argument
  if (!isStats && typeof entity !== 'string' && !Buffer.isBuffer(entity)) ***REMOVED***
    throw new TypeError('argument entity must be string, Buffer, or fs.Stats')
  ***REMOVED***

  // generate entity tag
  var tag = isStats
    ? stattag(entity)
    : entitytag(entity)

  return weak
    ? 'W/' + tag
    : tag
***REMOVED***

/**
 * Determine if object is a Stats object.
 *
 * @param ***REMOVED***object***REMOVED*** obj
 * @return ***REMOVED***boolean***REMOVED***
 * @api private
 */

function isstats(obj) ***REMOVED***
  // genuine fs.Stats
  if (typeof Stats === 'function' && obj instanceof Stats) ***REMOVED***
    return true
  ***REMOVED***

  // quack quack
  return obj && typeof obj === 'object'
    && 'ctime' in obj && toString.call(obj.ctime) === '[object Date]'
    && 'mtime' in obj && toString.call(obj.mtime) === '[object Date]'
    && 'ino' in obj && typeof obj.ino === 'number'
    && 'size' in obj && typeof obj.size === 'number'
***REMOVED***

/**
 * Generate a tag for a stat.
 *
 * @param ***REMOVED***object***REMOVED*** stat
 * @return ***REMOVED***string***REMOVED***
 * @private
 */

function stattag(stat) ***REMOVED***
  var mtime = stat.mtime.getTime().toString(16)
  var size = stat.size.toString(16)

  return '"' + size + '-' + mtime + '"'
***REMOVED***
